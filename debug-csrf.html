<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSRF Debug Tool</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            background: #252526;
            border-radius: 5px;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 3px;
            margin: 5px;
        }

        button:hover {
            background: #1177bb;
        }

        .success {
            color: #4ec9b0;
        }

        .error {
            color: #f48771;
        }

        .warning {
            color: #dcdcaa;
        }

        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>üîç CSRF Token Debug Tool</h1>

    <div class="section">
        <h2>Configuration</h2>
        <label>Backend URL:</label>
        <input type="text" id="backendUrl" value="https://reelify-pr6n.onrender.com"
            style="width: 100%; padding: 5px; margin: 5px 0;">
    </div>

    <div class="section">
        <h2>Tests</h2>
        <button onclick="testHealth()">1. Test /api/health</button>
        <button onclick="testDebugCsrf()">2. Test /api/debug/csrf</button>
        <button onclick="checkCookies()">3. Check Browser Cookies</button>
        <button onclick="testFoodPost()">4. Test POST /api/food</button>
    </div>

    <div class="section">
        <h2>Results</h2>
        <div id="results"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const results = document.getElementById('results');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            results.innerHTML += `<div class="${className}">${message}</div>`;
        };

        const clearResults = () => {
            document.getElementById('results').innerHTML = '';
        };

        const getBackendUrl = () => document.getElementById('backendUrl').value;

        async function testHealth() {
            clearResults();
            log('Testing /api/health endpoint...');

            try {
                const response = await fetch(`${getBackendUrl()}/api/health`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    log('‚úÖ Health endpoint responded successfully', 'success');
                    const data = await response.json();
                    log(`Response: ${JSON.stringify(data)}`);

                    // Check Set-Cookie header
                    const setCookie = response.headers.get('set-cookie');
                    if (setCookie) {
                        log(`Set-Cookie header: ${setCookie}`, 'success');
                    } else {
                        log('‚ö†Ô∏è No Set-Cookie header in response', 'warning');
                    }
                } else {
                    log(`‚ùå Health endpoint failed: ${response.status}`, 'error');
                }
            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
            }
        }

        async function testDebugCsrf() {
            clearResults();
            log('Testing /api/debug/csrf endpoint...');

            try {
                const response = await fetch(`${getBackendUrl()}/api/debug/csrf`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Debug endpoint responded:', 'success');
                    log(`<pre>${JSON.stringify(data, null, 2)}</pre>`);

                    if (data.hasCsrfCookie) {
                        log('‚úÖ CSRF cookie is set on backend', 'success');
                    } else {
                        log('‚ùå CSRF cookie NOT set on backend', 'error');
                    }
                } else {
                    log(`‚ùå Debug endpoint failed: ${response.status}`, 'error');
                }
            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
            }
        }

        function checkCookies() {
            clearResults();
            log('Checking browser cookies...');

            const cookies = document.cookie;
            if (!cookies) {
                log('‚ùå No cookies found in browser', 'error');
                log('This means the CSRF cookie is not being set or not accessible from JavaScript');
                return;
            }

            log(`All cookies: ${cookies}`);

            const csrfToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrf_token='))
                ?.split('=')[1];

            if (csrfToken) {
                log(`‚úÖ CSRF token found: ${csrfToken.substring(0, 20)}...`, 'success');
            } else {
                log('‚ùå CSRF token NOT found in cookies', 'error');
                log('Possible reasons:', 'warning');
                log('1. Cookie has httpOnly=true (check backend code)');
                log('2. Cookie domain mismatch');
                log('3. Cookie not being set by backend');
                log('4. CORS credentials not working');
            }
        }

        async function testFoodPost() {
            clearResults();
            log('Testing POST /api/food...');

            const csrfToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrf_token='))
                ?.split('=')[1];

            if (!csrfToken) {
                log('‚ùå Cannot test POST - no CSRF token found', 'error');
                log('Run test 1 and 3 first to get the CSRF token');
                return;
            }

            log(`Using CSRF token: ${csrfToken.substring(0, 20)}...`);

            try {
                const response = await fetch(`${getBackendUrl()}/api/food`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-csrf-token': csrfToken
                    },
                    body: JSON.stringify({
                        title: 'Test Food',
                        description: 'Testing CSRF'
                    })
                });

                log(`Response status: ${response.status}`);

                if (response.status === 403) {
                    log('‚ùå Got 403 Forbidden - CSRF validation failed', 'error');
                    const data = await response.json();
                    log(`Error: ${JSON.stringify(data)}`);
                } else if (response.status === 401) {
                    log('‚ö†Ô∏è Got 401 Unauthorized - you need to login first', 'warning');
                    log('But CSRF token was accepted! ‚úÖ', 'success');
                } else if (response.ok) {
                    log('‚úÖ Request succeeded!', 'success');
                    const data = await response.json();
                    log(`Response: ${JSON.stringify(data)}`);
                } else {
                    log(`‚ö†Ô∏è Got ${response.status} - check backend logs`, 'warning');
                }
            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
            }
        }

        // Auto-run health check on load
        window.addEventListener('load', () => {
            setTimeout(testHealth, 500);
        });
    </script>
</body>

</html>